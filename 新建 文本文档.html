<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>贪吃蛇</title>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<style>
    body{margin:0;background:#111;display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial,sans-serif}
    #gameCanvas{background:#000;border:2px solid #fff}
    #info{color:#fff;margin-left:20px}
    #info h3{margin:0 0 10px}
    #leaderboard{list-style:none;padding:0;margin:0}
    
    /* 开始界面 */
    #startScreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000000; /* 纯黑色 */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        z-index: 10;
    }
    
    #startButton {
        padding: 15px 30px;
        font-size: 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 20px;
    }
    
    #startButton:hover {
        background-color: #45a049;
    }
    
    /* 死亡页面 */
    #deathScreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        z-index: 10;
    }
    
    #deathMessage {
        display: none;
    }
    
    #deathScore {
        display: none;
    }
    
    #respawnButton {
        display: none;
    }
    background-color: rgba(0, 0, 0, 0.8); /* 半透明黑色 */
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    z-index: 10;
    }
    
    #deathMessage {
        font-size: 32px;
        margin-bottom: 20px;
        text-align: center;
    }
    
    #deathScore {
        font-size: 24px;
        margin-bottom: 30px;
    }
    
    #respawnButton {
        padding: 15px 30px;
        font-size: 20px;
        background-color: #f44336;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    
    #respawnButton:hover {
        background-color: #d32f2f;
    }
    
    /* 手机版虚拟按键 */
    #mobileControls {
        display: none;
        position: fixed;
        bottom: 20px;
        width: 100%;
        text-align: center;
    }
    
    .control-btn {
        width: 100px;
        height: 100px;
        margin: 10px;
        background-color: rgba(255, 255, 255, 0.2);
        border: 2px solid #fff;
        border-radius: 50%;
        color: white;
        font-size: 24px;
        cursor: pointer;
        user-select: none;
        display: inline-block;
        line-height: 100px;
    }
    
    .control-btn:active {
        background-color: rgba(255, 255, 255, 0.4);
    }
    
    @media (max-width: 768px) {
        body {
            flex-direction: column;
        }
        
        #info {
            margin-left: 0;
            margin-top: 20px;
            text-align: center;
        }
        
        #mobileControls {
            display: block;
        }
    }
</style>
</head>
<body>
<!-- 开始界面 -->
<div id="startScreen">
    <h1>贪吃蛇游戏</h1>
    <button id="startButton">开始游戏</button>
</div>

<!-- 死亡页面 -->
<div id="deathScreen">
    <svg width="400" height="400" xmlns="http://www.w3.org/2000/svg">
        <!-- 深色背景 -->
        <rect width="100%" height="100%" fill="#1a1a1a"/>
        
        <!-- 像素草地背景（底部） -->
        <g transform="translate(0, 300)">
            <!-- 草地方块 -->
            <rect x="0" y="0" width="400" height="100" fill="#4a7023"/>
            <!-- 草皮纹理 -->
            <rect x="0" y="0" width="400" height="20" fill="#7cba4d"/>
            <rect x="20" y="0" width="360" height="10" fill="#5a8a2f"/>
            
            <!-- 随机草地点缀 -->
            <rect x="50" y="5" width="10" height="5" fill="#a5d46a"/>
            <rect x="120" y="8" width="8" height="4" fill="#a5d46a"/>
            <rect x="200" y="3" width="12" height="6" fill="#a5d46a"/>
            <rect x="300" y="7" width="9" height="5" fill="#a5d46a"/>
        </g>
        
        <!-- 石头方块背景（两侧） -->
        <g transform="translate(0, 200)">
            <!-- 左侧石柱 -->
            <rect x="50" y="0" width="60" height="100" fill="#6e6e6e"/>
            <rect x="50" y="0" width="60" height="20" fill="#9c9c9c"/>
            
            <!-- 右侧石柱 -->
            <rect x="290" y="0" width="60" height="100" fill="#6e6e6e"/>
            <rect x="290" y="0" width="60" height="20" fill="#9c9c9c"/>
        </g>
    
        <!-- 死亡文字（使用 Minecraft 风格字体） -->
        <text 
            x="200" 
            y="150" 
            font-family="'Minecraft', 'Minecraftia', monospace" 
            font-size="48" 
            text-anchor="middle" 
            fill="#ffffff" 
            stroke="#3f3f3f" 
            stroke-width="2" 
            letter-spacing="2px"> 
            YOU DIED! 
        </text> 
        
        <!-- 副标题 -->
        <text 
            x="200" 
            y="190" 
            font-family="'Minecraft', 'Minecraftia', monospace" 
            font-size="16" 
            text-anchor="middle" 
            fill="#aaaaaa"> 
            Press ESC to respawn 
        </text> 
    </svg>
    <div id="deathMessage">你死了！</div>
    <div id="deathScore">得分: 0</div>
    <button id="respawnButton">重生</button>
</div>

<canvas id="gameCanvas" width="400" height="400"></canvas>
<div id="info">
    <h3>贪吃蛇</h3>
    <div>玩家ID：<span id="playerId"></span></div>
    <div>得分：<span id="score">0</span></div>
    <h4>排行榜</h4>
    <ul id="leaderboard"></ul>
</div>

<!-- 手机版虚拟按键 -->
<div id="mobileControls">
    <div class="control-btn" id="upBtn">↑</div><br>
    <div class="control-btn" id="leftBtn">←</div>
    <div class="control-btn" id="downBtn">↓</div>
    <div class="control-btn" id="rightBtn">→</div>
</div>

<script>
/* ========== 基础参数 ========== */
const canvas = document.getElementById('gameCanvas');
const ctx    = canvas.getContext('2d');
const grid   = 20;
const width  = canvas.width;
const height = canvas.height;

let snake    = [{x:200, y:200}];
let direction= 'right';
let food     = randomFood();
let score    = 0;
let playerId = Date.now();
let gameRunning = false;
let gameInterval;

// 显示玩家ID
document.getElementById('playerId').textContent = playerId;

/* ========== 网络（排行榜） ========== */
// 如果本地没有 ws://localhost:8081 服务，把下面两行注释掉即可单机玩
const socket = io('' + window.location.hostname + ':8082');
socket.on('connect', () => {
    socket.emit('join', {id: playerId});
});
socket.on('leaderboard', (list) => {
    updateLeaderboard(list);
});

/* ========== 开始界面 ========== */
document.getElementById('startButton').addEventListener('click', () => {
    document.getElementById('startScreen').style.display = 'none';
    startGame();
});

/* ========== 游戏主循环 ========== */
function startGame() {
    if (gameRunning) return;
    gameRunning = true;
    
    document.addEventListener('keydown', e => {
        const key = e.key;
        if(key==='ArrowUp'    && direction!=='down')  direction='up';
        if(key==='ArrowDown'  && direction!=='up')    direction='down';
        if(key==='ArrowLeft'  && direction!=='right') direction='left';
        if(key==='ArrowRight' && direction!=='left')  direction='right';
    });

    // 手机版虚拟按键事件
    document.getElementById('upBtn').addEventListener('click', () => {
        if(direction !== 'down') direction = 'up';
    });

    document.getElementById('downBtn').addEventListener('click', () => {
        if(direction !== 'up') direction = 'down';
    });

    document.getElementById('leftBtn').addEventListener('click', () => {
        if(direction !== 'right') direction = 'left';
    });

    document.getElementById('rightBtn').addEventListener('click', () => {
        if(direction !== 'left') direction = 'right';
    });

    gameInterval = setInterval(gameTick, 100);
}

function gameTick(){
    moveSnake();
    if(checkCollision()) return gameOver();
    if(eatFood()) {
        score++;
        document.getElementById('score').textContent = score;
        food = randomFood();
        sendScore();          // 上传分数
    }
    draw();
}

/* ========== 逻辑 ========== */
function moveSnake(){
    const head = {x:snake[0].x, y:snake[0].y};
    switch(direction){
        case 'up':    head.y -= grid; break;
        case 'down':  head.y += grid; break;
        case 'left':  head.x -= grid; break;
        case 'right': head.x += grid; break;
    }
    snake.unshift(head);
    if(head.x!==food.x || head.y!==food.y) snake.pop();
}

function eatFood(){ return snake[0].x===food.x && snake[0].y===food.y; }

function checkCollision(){
    const h = snake[0];
    if(h.x<0||h.x>=width||h.y<0||h.y>=height) return true;
    for(let i=1;i<snake.length;i++) if(h.x===snake[i].x && h.y===snake[i].y) return true;
    return false;
}

function gameOver(){
    // 显示死亡页面
    document.getElementById('deathScore').textContent = '得分: ' + score;
    document.getElementById('deathScreen').style.display = 'flex';
    
    clearInterval(gameInterval);
    gameRunning = false;
}

/* ========== 绘图 ========== */
function draw(){
    ctx.clearRect(0,0,width,height);
    // 蛇
    ctx.fillStyle = '#0f0';
    snake.forEach(s => ctx.fillRect(s.x,s.y,grid,grid));
    // 食物
    ctx.fillStyle = '#f00';
    ctx.fillRect(food.x,food.y,grid,grid);
}

function randomFood(){
    return {
        x: Math.floor(Math.random()*(width/grid))*grid,
        y: Math.floor(Math.random()*(height/grid))*grid
    };
}

/* ========== 排行榜 ========== */
function sendScore(){
    socket.emit('score', {id: playerId, score});
}
function updateLeaderboard(list){
    const ul = document.getElementById('leaderboard');
    ul.innerHTML = '';
    list.sort((a,b)=>b.score-a.score).slice(0,5).forEach(item=>{
        const li = document.createElement('li');
        // 只显示IP地址的最后一位
        const ipParts = item.ip ? item.ip.split('.') : [];
        const ipDisplay = ipParts.length > 0 ? ipParts[ipParts.length - 1] : '未知';
        li.textContent = `玩家${ipDisplay}：${item.score}`;
        ul.appendChild(li);
    });
}

/* ========== 死亡页面 ========== */
// 重生按钮事件处理
document.getElementById('respawnButton').addEventListener('click', () => {
    respawn();
});

// 按ESC键重生
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !gameRunning) {
        respawn();
    }
});

function respawn() {
    // 隐藏死亡页面
    document.getElementById('deathScreen').style.display = 'none';
    
    // 重置游戏状态
    snake = [{x:200,y:200}];
    direction = 'right';
    score = 0;
    document.getElementById('score').textContent = 0;
    
    // 重新开始游戏
    startGame();
}
</script>
</body>
</html>